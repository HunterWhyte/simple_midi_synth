// a C version of this https://mitxela.com/projects/midi_on_the_attiny
/*USBASP pins
 RST 1
 GND 10
 MOSI 17
 MISO 18
 SCK 19
 VCC 20
*/
#define F_CPU 8000000UL // 1 MHz
//program CKDIV8 to be 1 which means no div of internal clk
// this is bit no. 7 of Fuse low byte
#include <avr/io.h>
//headphone breakout board 1-GND, 2-LEFT, 3-RIGHT
#include <avr/pgmspace.h>

unsigned char pitchLUT[256] PROGMEM  = 	  { 0xFF,0xFF,0xF1,0xA1,0xE4,0x11,0xD7,0x44,0xCB,0x2F,0xBF,0xC8,0xB5,0x04,0xAA,0xDB,
										0xA1,0x44,0x98,0x37,0x8F,0xAC,0x87,0x9C,0x80,0x00,0x78,0xD0,0x72,0x09,0x6B,0xA2,
										0x65,0x98,0x5F,0xE4,0x5A,0x82,0x55,0x6E,0x50,0xA2,0x4C,0x1C,0x47,0xD6,0x43,0xCE,
										0x40,0x00,0x3C,0x68,0x39,0x04,0x35,0xD1,0x32,0xCC,0x2F,0xF2,0x2D,0x41,0x2A,0xB7,
										0x28,0x51,0x26,0x0E,0x23,0xEB,0x21,0xE7,0x20,0x00,0x1E,0x34,0x1C,0x82,0x1A,0xE9,
										0x19,0x66,0x17,0xF9,0x16,0xA1,0x15,0x5B,0x14,0x29,0x13,0x07,0x11,0xF6,0x10,0xF3,
										0x10,0x00,0x0F,0x1A,0x0E,0x41,0x0D,0x74,0x0C,0xB3,0x0B,0xFC,0x0B,0x50,0x0A,0xAE,
										0x0A,0x14,0x09,0x83,0x08,0xFB,0x08,0x7A,0x08,0x00,0x07,0x8D,0x07,0x21,0x06,0xBA,
										0x06,0x59,0x05,0xFE,0x05,0xA8,0x05,0x57,0x05,0x0A,0x04,0xC2,0x04,0x7D,0x04,0x3D,
										0x04,0x00,0x03,0xC7,0x03,0x90,0x03,0x5D,0x03,0x2D,0x02,0xFF,0x02,0xD4,0x02,0xAB,
										0x02,0x85,0x02,0x61,0x02,0x3F,0x02,0x1E,0x02,0x00,0x01,0xE3,0x01,0xC8,0x01,0xAF,
										0x01,0x96,0x01,0x80,0x01,0x6A,0x01,0x56,0x01,0x43,0x01,0x30,0x01,0x1F,0x01,0x0F,
										0x01,0x00,0x00,0xF2,0x00,0xE4,0x00,0xD7,0x00,0xCB,0x00,0xC0,0x00,0xB5,0x00,0xAB,
										0x00,0xA1,0x00,0x98,0x00,0x90,0x00,0x88,0x00,0x80,0x00,0x79,0x00,0x72,0x00,0x6C,
										0x00,0x66,0x00,0x60,0x00,0x5B,0x00,0x55,0x00,0x51,0x00,0x4C,0x00,0x48,0x00,0x44,
										0x00,0x40,0x00,0x3C,0x00,0x39,0x00,0x36,0x00,0x33,0x00,0x30,0x00,0x2D};
unsigned char rxByte(void);	

int main(void)
{	
	
	DDRB   |= (1 << PB3);                   // PWM output on PB3
	TCCR1A = (1 << COM1A0);  // phase correct PWM mode
	TCCR1B = (1 << WGM12) | (1 << CS10);
	OCR1AH = 0x2F;     
	OCR1AL = 0x00;     
	UBRRH = 0; // baud rate
	UBRRL = 15;
	UCSRB = (1<<RXEN);  // enable reciever
	UCSRC = (1<<UCSZ1|1<<UCSZ0); 
	// LEDs are on portD 0
	//DDRD = 0xff; //portD is output
	unsigned char status;
	unsigned char note = 0xFF;
	unsigned char noteoff = 0xFF;
	unsigned char pitch;
	
	while(1)
	{
		status = rxByte();
		if (status == 0b10000000){
			//note off
			noteoff = rxByte();
			if(noteoff == note){
				TCCR1B = 0; // turn off PWM
			}
		}
		else if (status == 0b10010000){
			//note on
			note = rxByte();
			pitch = (note - 27) << 1;
			TCCR1B = (1 << WGM12) | (1 << CS10); // turn on PWM
			
			OCR1AH = pgm_read_byte(&pitchLUT[pitch]);
			OCR1AL = pgm_read_byte(&pitchLUT[pitch]);
		}

		
		//final = pgm_read_byte(&mod[status]);
		

	}
}

unsigned char rxByte(void){
	while((UCSRA &(1<<RXC)) == 0);
	return UDR;
}